"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _react = require("react");
require("./Table.scss");
const DEFAULT_WIDTH = 100;
const useResizeble = (tableRef, theadRef, headers, tableId) => {
  const [index, setIndex] = (0, _react.useState)(headers);
  const [column, setColumn] = (0, _react.useState)(null);
  const [pressed, setPressed] = (0, _react.useState)(false);
  const [startX, setStartX] = (0, _react.useState)(null);
  const [startWidth, setStartWidth] = (0, _react.useState)(null);
  const [width, setWidth] = (0, _react.useState)(null);
  const [columnName, setColumnName] = (0, _react.useState)('');
  (0, _react.useEffect)(() => {
    setColumnName(column?.dataset?.name);
  }, [column, index]);
  const onMouseDown = (event, index) => {
    setIndex(index);
    setPressed(true);
    setStartX(event.pageX);
    setColumn(event.target.parentElement);
    setStartWidth(event.target.parentElement.offsetWidth);
  };
  const onMouseMove = event => {
    const offset = 1;
    if (pressed && event.buttons) {
      let width = startWidth + (event.pageX - startX - offset);
      if (width < DEFAULT_WIDTH) {
        event.stopPropagation();
        return;
      }
      setWidth(width);
      changeHeaderStyles('add');
      const rows = getRows(index);
      column.style.width = `${width}px`;
      column.style.width = `${width}px`;
      for (const row of rows) {
        row.style.width = `${width}px`;
      }
    }
  };
  const onMouseUp = () => {
    if (pressed) {
      setPressed(false);
      setIndex(null);
      setWidth(null);
      setColumnName('');
      changeHeaderStyles('remove');
      const name = column.querySelector('.column-info')?.innerText?.split(' ')?.join('').toUpperCase();
      persistTableStorage({
        column: name,
        value: column.getBoundingClientRect()?.width
      });
    }
  };
  const loadTableSettings = () => {
    const headers = getHeaders();
    headers?.forEach((head, index) => {
      const name = head?.innerText?.split(' ')?.join('').toUpperCase();
      setColumnWidth(head, index, name);
    });
  };
  const setColumnWidth = (container, index, name) => {
    const storage = getTableStorage();
    const currentStorage = storage ? JSON.parse(storage)?.resizeble?.[tableId] : null;
    const rows = getRows(index);
    if (!currentStorage) return;
    for (const key in currentStorage) {
      const width = currentStorage[key];
      if (name === key) {
        container.style.width = `${width}px`;
        for (const row of rows) {
          row.style.width = `${width}px`;
        }
      }
    }
  };
  const getTableStorage = () => {
    return localStorage.getItem('__magnunTablePreferences');
  };
  const persistTableStorage = item => {
    if (!tableId) return;
    const storage = getTableStorage();
    const resizebleStorage = storage ? JSON.parse(storage)?.resizeble : null;
    if (!storage) {
      return localStorage.setItem('__magnunTablePreferences', JSON.stringify({
        resizeble: {
          [tableId]: {
            [item.column]: item.value
          }
        }
      }));
    }
    const newValues = {
      ...resizebleStorage,
      [tableId]: {
        ...resizebleStorage?.[tableId],
        [item.column]: item.value
      }
    };
    localStorage.setItem('__magnunTablePreferences', JSON.stringify({
      ...JSON.parse(storage),
      resizeble: newValues
    }));
  };
  const getHeaders = () => {
    return theadRef?.current?.querySelector(`[identifier="${tableId}"]`)?.childNodes;
  };
  const getRows = index => {
    const rows = Array.from(tableRef.current.getElementsByTagName('tr'))?.map(row => row.getElementsByTagName('td').item(index));
    rows.shift();
    return rows;
  };
  const setsFirstColumnToFixed = offset => {
    const header = getHeaders()[0];
    const rows = getRows(0);
    if (offset > 5) header.classList.add('fixed__first__column');
    if (offset < 5) header.classList.remove('fixed__first__column');
    for (const row of rows) {
      if (offset > 5) row.classList.add('fixed__first__column');
      if (offset < 5) row.classList.remove('fixed__first__column');
    }
  };
  const dispatchScroll = () => {
    if (tableRef.current.scrollLeft > 5) tableRef.current.dispatchEvent(new CustomEvent('scroll'));
  };
  const changeHeaderStyles = action => {
    const resizable = column.querySelector("[data-type='resizable']");
    const name = column.querySelector("[data-type='name']");
    const originalName = column.dataset.name;
    name.innerText = originalName;
    if (action === 'add') {
      tableRef.current.style.cursor = 'col-resize';
      resizable.classList.add('resizing');
      return;
    }
    tableRef.current.style.cursor = 'default';
    resizable.classList.remove('resizing');
    name.innerText = originalName;
  };
  return {
    onMouseDown,
    onMouseMove,
    onMouseUp,
    dispatchScroll,
    loadTableSettings,
    setsFirstColumnToFixed,
    pressed
  };
};
var _default = exports.default = useResizeble;